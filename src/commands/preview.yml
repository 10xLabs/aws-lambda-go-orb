description: >
  This command create a preview of the Pulumi stack changes

parameters:
  working-directory:
    type: string
    default: deploy
  stack-name:
    type: string
    default: ""
  install-pulumi-deps:
    type: boolean
    default: true
  setup-remote-docker:
    type: boolean
    default: false

steps:
  - attach_workspace:
      at: .
  - run:
      name: Set stack name
      environment:
        STACK_NAME: << parameters.stack-name >>
      command: << include(scripts/set_stack_name.sh) >>
  - run: pulumi version
  - when:
      condition:
        equal: [true, << parameters.install-pulumi-deps >>]
      steps:
        - restore_cache:
            keys:
              - v1-deps-{{ checksum "<< parameters.working-directory >>/yarn.lock" }}
              - v1-deps-
        - run:
            name: Install Pulumi Dependencies
            environment:
              WORKING_DIRECTORY: << parameters.working-directory >>
            command: << include(scripts/install_pulumi_deps.sh) >>
        - save_cache:
            key: v1-deps-{{ checksum "<< parameters.working-directory >>/yarn-lock.json" }}
            paths:
              - << parameters.working-directory >>/node_modules
  - when:
      condition:
        equal: [true, << parameters.setup-remote-docker >>]
      steps:
        - setup_remote_docker:
            version: 20.10.23
            docker_layer_caching: true
  - run:
      name: Pulumi preview
      environment:
        WORKING_DIRECTORY: << parameters.working-directory >>
      command: << include(scripts/pulumi_preview.sh) >>
